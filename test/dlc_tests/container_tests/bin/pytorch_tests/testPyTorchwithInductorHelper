#!/bin/bash

HOME_DIR=/test
BIN_DIR=${HOME_DIR}/bin
LOG_DIR=${HOME_DIR}/logs

EXAMPLESDIR=${HOME_DIR}/artifacts/examples
set -e
cd ${EXAMPLESDIR}

TRAINING_LOG=${LOG_DIR}/pytorch_train_mnist_inductor.log

echo "Training mnist using PyTorch inductor... This may take a few minutes. You can follow progress on the log file : $TRAINING_LOG"
set +e

sed -i 's/import torch/&\nimport logging"/g' mnist/main.py
sed -i 's/import logging/&\ntorch._dynamo.config.log_level = logging.INFO"/g' mnist/main.py
sed -i 's/model = Net().to(device)/&\n    model = torch.compile(model, backend='inductor', mode='default')/g' mnist/main.py

python mnist/main.py 2>&1 | tee $TRAINING_LOG
RETURN_VAL=[`echo $?`] && [grep -Fxq "torchinductor done compiling" $TRAINING_LOG]
set -e

if [ ${RETURN_VAL} -eq 0 ]; then
    echo "Training mnist Complete using PyTorch with inductor."
else
    echo "Training mnist Failed using PyTorch with inductor."
    cat $TRAINING_LOG
    exit 1
fi


exit 0
